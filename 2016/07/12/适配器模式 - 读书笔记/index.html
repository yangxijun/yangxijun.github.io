	<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>适配器模式 - 读书笔记 | Yangxijun&#39;s Blog</title>
  <meta name="author" content="Yangxijun">
  
  <meta name="description" content="来自Android源码设计模式解析与实战的第二十章，得心应手的“粘合剂”——适配器模式
1. ListView和AdapterListView中并没有Adapter相关的成员变量 ，其实Adapter在ListView的父类AbsListView中。
由于每次修改布局后ListView会调用onLa">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="适配器模式 - 读书笔记"/>
  <meta property="og:site_name" content="Yangxijun&#39;s Blog"/>

  
  
		<!-- favicon -->
		<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
		<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
		<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.png">
		<meta name="theme-color" content="#009688">
		<!-- favicon end -->
    <!-- <link href="/favicon.ico" rel="icon"> -->
  

  <!-- toc -->
  <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css">

  <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">

  <!-- material design -->
	<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css">
  <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
	<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  

  

  <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="/libs/jquery-2.0.3.min.js" type="text/javascript"><\/script>')</script>

</head>

 	<body>
	  <nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">菜单</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Yangxijun&#39;s Blog</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    <a href="/" title="">
                    <i class="fa fa-home"></i>首页
                    </a>
                </li>
                
                <li>
                    <a href="/archives" title="">
                    <i class="fa fa-list"></i>存档
                    </a>
                </li>
                
                <li>
                    <a href="/about" title="">
                    <i class="fa fa-info-circle"></i>关于
                    </a>
                </li>
                
                <li>
                    <a href="/atom.xml" title="这是一个订阅源">
                    <i class="fa fa-rss"></i>RSS
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>

	  <div class="container" >
	    <div class="row">
	
	<div class="col-md-9 center-content">
	

		<div class="content">
			<!-- index -->
		   

			  		<h2>适配器模式 - 读书笔记</h2>
					
					<div>
						<span class="post-time">2016-07-12 00:36:43</span>
					</div>	
					

					<div class="article-content">
						<h1 id="来自Android源码设计模式解析与实战的第二十章，得心应手的“粘合剂”——适配器模式"><a href="#来自Android源码设计模式解析与实战的第二十章，得心应手的“粘合剂”——适配器模式" class="headerlink" title="来自Android源码设计模式解析与实战的第二十章，得心应手的“粘合剂”——适配器模式"></a>来自Android源码设计模式解析与实战的第二十章，得心应手的“粘合剂”——适配器模式</h1><hr>
<h2 id="1-ListView和Adapter"><a href="#1-ListView和Adapter" class="headerlink" title="1. ListView和Adapter"></a>1. ListView和Adapter</h2><p>ListView中并没有Adapter相关的成员变量 ，其实Adapter在ListView的父类AbsListView中。</p>
<p>由于每次修改布局后ListView会调用onLayout，所以直接看这部分代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.onLayout(changed, l, t, r, b);</span><br><span class="line">      mInLayout = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</span><br><span class="line">      <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</span><br><span class="line">              getChildAt(i).forceLayout();</span><br><span class="line">          &#125;</span><br><span class="line">          mRecycler.markChildrenDirty();</span><br><span class="line">      &#125;</span><br><span class="line">      layoutChildren();</span><br><span class="line">      mInLayout = <span class="keyword">false</span>;</span><br><span class="line">      mOverscrollMax = (b - t) / OVERSCROLL_LIMIT_DIVISOR;</span><br><span class="line">      <span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span>) &#123;</span><br><span class="line">          mFastScroll.onItemCountChanged(getChildCount(), mItemCount);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>AbsListView中没有实现layoutChildren，所以我们查看ListView中的对应方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> blockLayoutRequests = mBlockLayoutRequests;</span><br><span class="line">      	...</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">super</span>.layoutChildren();</span><br><span class="line">           invalidate();</span><br><span class="line">		...</span><br><span class="line">           <span class="keyword">switch</span> (mLayoutMode) &#123;</span><br><span class="line">           ...</span><br><span class="line">           <span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</span><br><span class="line">               sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</span><br><span class="line">               adjustViewsUpOrDown();</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> LAYOUT_FORCE_TOP:</span><br><span class="line">               mFirstPosition = <span class="number">0</span>;</span><br><span class="line">               sel = fillFromTop(childrenTop);</span><br><span class="line">               adjustViewsUpOrDown();</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           ...</span><br><span class="line">           &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>简单来说，它会根据mLayoutMode来决定布局，我们这里就只看fillUp方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillUp</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> nextBottom)</span> </span>&#123;</span><br><span class="line">       View selectedView = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">int</span> end = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</span><br><span class="line">           end = mListPadding.top;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">while</span> (nextBottom &gt; end &amp;&amp; pos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">// is this the selected item?</span></span><br><span class="line">           <span class="keyword">boolean</span> selected = pos == mSelectedPosition;</span><br><span class="line">           View child = makeAndAddView(pos, nextBottom, <span class="keyword">false</span>, mListPadding.left, selected);</span><br><span class="line">           nextBottom = child.getTop() - mDividerHeight;</span><br><span class="line">           <span class="keyword">if</span> (selected) &#123;</span><br><span class="line">               selectedView = child;</span><br><span class="line">           &#125;</span><br><span class="line">           pos--;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mFirstPosition = pos + <span class="number">1</span>;</span><br><span class="line">       setVisibleRangeHint(mFirstPosition, mFirstPosition + getChildCount() - <span class="number">1</span>);</span><br><span class="line">       <span class="keyword">return</span> selectedView;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>布局中会调用makeAndAddView来生成对应的view</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> View <span class="title">makeAndAddView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flow, <span class="keyword">int</span> childrenLeft,</span><br><span class="line">           <span class="keyword">boolean</span> selected)</span> </span>&#123;</span><br><span class="line">       View child;</span><br><span class="line">       <span class="keyword">if</span> (!mDataChanged) &#123;</span><br><span class="line">           child = mRecycler.getActiveView(position);</span><br><span class="line">           <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</span><br><span class="line">               setupChild(child, position, y, flow, childrenLeft, selected, <span class="keyword">true</span>);</span><br><span class="line">               <span class="keyword">return</span> child;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       child = obtainView(position, mIsScrap);</span><br><span class="line">       setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>]);</span><br><span class="line">       <span class="keyword">return</span> child;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里有两种情况</p>
<ul>
<li>如果数据没变动，则通过getActiveView取得缓存的view</li>
<li>否则都通过obtainView获得对应view</li>
</ul>
<p>obtainView是AbsListView的核心方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">View <span class="title">obtainView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span>[] isScrap)</span> </span>&#123;</span><br><span class="line">       isScrap[<span class="number">0</span>] = <span class="keyword">false</span>;</span><br><span class="line">	...</span><br><span class="line">       <span class="keyword">final</span> View scrapView = mRecycler.getScrapView(position);</span><br><span class="line">       <span class="keyword">final</span> View child = mAdapter.getView(position, scrapView, <span class="keyword">this</span>);</span><br><span class="line">       <span class="keyword">return</span> child;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这样，不论scrapView在不在缓存中，都会调用对应Adapter中的getView方法。、</p>
<h2 id="2-RecyclerView"><a href="#2-RecyclerView" class="headerlink" title="2. RecyclerView"></a>2. RecyclerView</h2><p>RecyclerView和ListView都使用了Adapter和观察者模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAdapter</span><span class="params">(Adapter adapter)</span> </span>&#123;</span><br><span class="line">       setLayoutFrozen(<span class="keyword">false</span>);</span><br><span class="line">       setAdapterInternal(adapter, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">       requestLayout();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setAdapterInternal</span><span class="params">(Adapter adapter, <span class="keyword">boolean</span> compatibleWithPrevious,</span><br><span class="line">           <span class="keyword">boolean</span> removeAndRecycleViews)</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">       mAdapterHelper.reset();</span><br><span class="line">       <span class="keyword">final</span> Adapter oldAdapter = mAdapter;</span><br><span class="line">       mAdapter = adapter;</span><br><span class="line">       <span class="keyword">if</span> (adapter != <span class="keyword">null</span>) &#123;</span><br><span class="line">           adapter.registerAdapterDataObserver(mObserver);</span><br><span class="line">           adapter.onAttachedToRecyclerView(<span class="keyword">this</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (mLayout != <span class="keyword">null</span>) &#123;</span><br><span class="line">           mLayout.onAdapterChanged(oldAdapter, mAdapter);</span><br><span class="line">       &#125;</span><br><span class="line">       mRecycler.onAdapterChanged(oldAdapter, mAdapter, compatibleWithPrevious);</span><br><span class="line">       mState.mStructureChanged = <span class="keyword">true</span>;</span><br><span class="line">       markKnownViewsInvalid();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里不难看出registerAdapterDataObserver注册后，让变化时会调用它的onChange接口，通过requestLayout方法重新布局。那我们需要看onLayout方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">       eatRequestLayout();</span><br><span class="line">       dispatchLayout();</span><br><span class="line">       resumeRequestLayout(<span class="keyword">false</span>);</span><br><span class="line">       mFirstLayoutComplete = <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">       mLayout.onLayoutChildren(mRecycler, mState);</span><br><span class="line">     	...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里的mLayout就是LayoutManager。以LinearLayoutManager为例，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLayoutChildren</span><span class="params">(RecyclerView.Recycler recycler,RecyclerView.State state)</span> </span>&#123;</span><br><span class="line">      	...</span><br><span class="line">       <span class="keyword">if</span> (mAnchorInfo.mLayoutFromEnd) &#123;</span><br><span class="line">           ...</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// fill towards end</span></span><br><span class="line">           updateLayoutStateToFillEnd(mAnchorInfo);</span><br><span class="line">           mLayoutState.mExtra = extraForEnd;</span><br><span class="line">           fill(recycler, mLayoutState, state, <span class="keyword">false</span>);</span><br><span class="line">           endOffset = mLayoutState.mOffset;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> lastElement = mLayoutState.mCurrentPosition;</span><br><span class="line">           <span class="keyword">if</span> (mLayoutState.mAvailable &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               extraForStart += mLayoutState.mAvailable;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// fill towards start</span></span><br><span class="line">           updateLayoutStateToFillStart(mAnchorInfo);</span><br><span class="line">           mLayoutState.mExtra = extraForStart;</span><br><span class="line">           mLayoutState.mCurrentPosition += mLayoutState.mItemDirection;</span><br><span class="line">           fill(recycler, mLayoutState, state, <span class="keyword">false</span>);</span><br><span class="line">           startOffset = mLayoutState.mOffset;</span><br><span class="line">       &#125;</span><br><span class="line">     	...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fill</span><span class="params">(RecyclerView.Recycler recycler, LayoutState layoutState,</span><br><span class="line">           RecyclerView.State state, <span class="keyword">boolean</span> stopOnFocusable)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// max offset we should set is mFastScroll + available</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> start = layoutState.mAvailable;</span><br><span class="line">       <span class="keyword">int</span> remainingSpace = layoutState.mAvailable + layoutState.mExtra;</span><br><span class="line">       LayoutChunkResult layoutChunkResult = <span class="keyword">new</span> LayoutChunkResult();</span><br><span class="line">       <span class="keyword">while</span> ((layoutState.mInfinite||remainingSpace&gt;<span class="number">0</span>)&amp;&amp;layoutState.hasMore(state)) &#123;</span><br><span class="line">           layoutChunkResult.resetInternal();</span><br><span class="line">           layoutChunk(recycler, state, layoutState, layoutChunkResult);</span><br><span class="line">           <span class="keyword">if</span> (layoutChunkResult.mFinished) &#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           ...</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> start - layoutState.mAvailable;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>onLayoutChilden会调用fill函数，在fill函数中又会循环调用layoutChunk函数进行布局。而layoutChunk中通过itemView的高宽，算出对应坐标，最后调用layoutDecorated函数实现布局。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layoutDecorated</span><span class="params">(View child, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">final</span> Rect insets = ((LayoutParams) child.getLayoutParams()).mDecorInsets;</span><br><span class="line">           child.layout(left + insets.left, top + insets.top, right - insets.right,</span><br><span class="line">                   bottom - insets.bottom);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>上述代码可以看出，布局的职责从RecyclerView分离到LayoutManager中。</p>
<p>再看看layoutChunk中获取view时调用的layoutState#next方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">View <span class="title">next</span><span class="params">(RecyclerView.Recycler recycler)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (mScrapList != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> nextViewFromScrapList();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">final</span> View view = recycler.getViewForPosition(mCurrentPosition);</span><br><span class="line">           mCurrentPosition += mItemDirection;</span><br><span class="line">           <span class="keyword">return</span> view;</span><br><span class="line">  	&#125;</span><br></pre></td></tr></table></figure>
<p>其中getViewForPosition方法就是用户获取对应item view的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">View <span class="title">getViewForPosition</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span> dryRun)</span> </span>&#123;</span><br><span class="line">            ViewHolder holder = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// 0) If there is a changed scrap, try to find from there</span></span><br><span class="line">            <span class="keyword">if</span> (mState.isPreLayout()) &#123;</span><br><span class="line">                holder = getChangedScrapViewForPosition(position);</span><br><span class="line">                fromScrap = holder != <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 1) Find from scrap by position</span></span><br><span class="line">            <span class="keyword">if</span> (holder == <span class="keyword">null</span>) &#123;</span><br><span class="line">                holder = getScrapViewForPosition(position, INVALID_TYPE, dryRun);</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (holder == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">                <span class="keyword">if</span> (holder == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    holder = mAdapter.createViewHolder(RecyclerView.<span class="keyword">this</span>, type);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">  			mAdapter.bindViewHolder(holder, offsetPosition);</span><br><span class="line">           	...</span><br><span class="line">            <span class="keyword">return</span> holder.itemView;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>简单流程为：</p>
<ul>
<li>从mChangedScrap获取缓存ViewHolder，getChangedScrapViewForPosition</li>
<li>从mAttachedScrap获取缓存ViewHolder，getScrapViewForPosition</li>
<li>若还是空，则调用mAdapter中的createViewHolder创建对应view</li>
<li>最后是通过mAdapter中的bindViewHolder进行数据绑定</li>
</ul>

					</div>

			  <!-- about -->
			  
		</div>

		<!-- pagination -->
	  

		<div class="comment-section">
  
  


</div>
	</div>

	

</div>


		<footer>
			

<p>
  由 <a href="https://hexo.io">hexo</a> 强力驱动 | 搭载 <a href="https://github.com/wayou/hexo-theme-material">material</a> 主题
</p>
<p>
  &copy; 2016 <a href="http://yoursite.com"> Yangxijun </a>
</p>
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	  </div>

		<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>

		<!-- material design -->
		<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script>
		<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>
		<!-- toc -->
		<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
		<script src="/libs/tocify/jquery.tocify.custom.js"></script>

		<script src="/js/main.js"></script>

	</body>
</html>
